using SharedKernel.Application.Models.Abstractions.Errors;
using SharedKernel.Application.Models.Abstractions.Interfaces.ApplicationManager.Operators.Generic.Operations;
using SharedKernel.Application.Models.Abstractions.Interfaces.ApplicationManager.Operators.Permissions.Operations.CRUD.Commands;
using SharedKernel.Application.Models.Abstractions.Interfaces.ApplicationManager.Services.Persistence.Generic_Repositories;
using SharedKernel.Domain.Models.Entities.Users.Authorizations;

namespace Users.Application.Operators.Permissions.Operations.CRUD.Commands.UpdatePermission {

    /// <summary>
    /// Manejador para el comando de actualización de permiso.
    /// </summary>
    public class UpdatePermission_CommandHandler : IOperationHandler<IUpdatePermission_Command, Permission> {

        private IPermissionRepository _permissionRepository { get; }

        public UpdatePermission_CommandHandler (IPermissionRepository permissionRepository) =>
            _permissionRepository = permissionRepository;

        ///// <summary>
        ///// Maneja el comando de actualización de un permiso de forma asíncrona.
        ///// </summary>
        ///// <param name="command">El comando que contiene la actualización del permiso.</param>
        ///// <returns>Una tarea que representa la operación asíncrona y contiene el permiso actualizado.</returns>
        public async Task<Permission> Handle (IUpdatePermission_Command command) {

            // Verifica si el comando es nulo
            if (command == null)
                throw BadRequestError.Create("El comando no puede ser nulo.");

            // Verifica si la instancia Partial<Permission> es nula
            if (command.EntityUpdate == null)
                throw BadRequestError.Create("La actualización del permiso de usuario no puede ser nula.");

            var permissionUpdate = command.EntityUpdate;

            // Lista para almacenar los errores de validación
            var validationErrors = new List<ApplicationError>();

            // Valida el identificador del permiso.
            if (!permissionUpdate.ID.HasValue || (int) permissionUpdate.ID == default)
                validationErrors.Add(ValidationError.Create(nameof(Permission.ID), "El identificador del permiso de usuario no es válido."));

            // Si está presente, valida el nombre del permiso de usuario.
            var nameProperty = nameof(Permission.Name);
            if (permissionUpdate.Properties.TryGetValue(nameProperty, out var nameValue)) {
                var name = nameValue as string;
                if (string.IsNullOrWhiteSpace(name))
                    validationErrors.Add(ValidationError.Create(nameProperty, "El nombre del permiso de usuario no puede estar vacío."));
                else if (await _permissionRepository.FirstOrDefault(permission => permission.Name!.Equals(name)) != null)
                    validationErrors.Add(ValidationError.Create(nameProperty, $"El nombre del permiso de usuario «{name}» ya existe."));
            }

            // Si hay errores de validación lanza un «AggregateError».
            if (validationErrors.Count > 0)
                throw AggregateError.Create(validationErrors);

            // Ejecuta la actualización del permiso de usuario de forma asíncrona.
            return await _permissionRepository.UpdatePermission(permissionUpdate);

        }

    }

}